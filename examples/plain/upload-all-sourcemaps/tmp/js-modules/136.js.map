{"version":3,"sources":["/Users/jamielynch/repos/bugsnag-react-native/examples/plain/node_modules/react-native/Libraries/WebSocket/WebSocket.js"],"sourcesContent":["/**\n * Copyright (c) 2015-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @format\n * @flow\n */\n\n'use strict';\n\nconst Blob = require('Blob');\nconst EventTarget = require('event-target-shim');\nconst NativeEventEmitter = require('NativeEventEmitter');\nconst BlobManager = require('BlobManager');\nconst NativeModules = require('NativeModules');\nconst Platform = require('Platform');\nconst WebSocketEvent = require('WebSocketEvent');\n\n/* $FlowFixMe(>=0.54.0 site=react_native_oss) This comment suppresses an error\n * found when Flow v0.54 was deployed. To see the error delete this comment and\n * run Flow. */\nconst base64 = require('base64-js');\nconst binaryToBase64 = require('binaryToBase64');\nconst invariant = require('fbjs/lib/invariant');\n\nconst {WebSocketModule} = NativeModules;\n\nimport type EventSubscription from 'EventSubscription';\n\ntype ArrayBufferView =\n  | Int8Array\n  | Uint8Array\n  | Uint8ClampedArray\n  | Int16Array\n  | Uint16Array\n  | Int32Array\n  | Uint32Array\n  | Float32Array\n  | Float64Array\n  | DataView;\n\ntype BinaryType = 'blob' | 'arraybuffer';\n\nconst CONNECTING = 0;\nconst OPEN = 1;\nconst CLOSING = 2;\nconst CLOSED = 3;\n\nconst CLOSE_NORMAL = 1000;\n\nconst WEBSOCKET_EVENTS = ['close', 'error', 'message', 'open'];\n\nlet nextWebSocketId = 0;\n\n/**\n * Browser-compatible WebSockets implementation.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\n * See https://github.com/websockets/ws\n */\nclass WebSocket extends EventTarget(...WEBSOCKET_EVENTS) {\n  static CONNECTING = CONNECTING;\n  static OPEN = OPEN;\n  static CLOSING = CLOSING;\n  static CLOSED = CLOSED;\n\n  CONNECTING: number = CONNECTING;\n  OPEN: number = OPEN;\n  CLOSING: number = CLOSING;\n  CLOSED: number = CLOSED;\n\n  _socketId: number;\n  _eventEmitter: NativeEventEmitter;\n  _subscriptions: Array<EventSubscription>;\n  _binaryType: ?BinaryType;\n\n  onclose: ?Function;\n  onerror: ?Function;\n  onmessage: ?Function;\n  onopen: ?Function;\n\n  bufferedAmount: number;\n  extension: ?string;\n  protocol: ?string;\n  readyState: number = CONNECTING;\n  url: ?string;\n\n  // This module depends on the native `WebSocketModule` module. If you don't include it,\n  // `WebSocket.isAvailable` will return `false`, and WebSocket constructor will throw an error\n  static isAvailable: boolean = !!WebSocketModule;\n\n  constructor(\n    url: string,\n    protocols: ?string | ?Array<string>,\n    options: ?{headers?: {origin?: string}},\n  ) {\n    super();\n    if (typeof protocols === 'string') {\n      protocols = [protocols];\n    }\n\n    const {headers = {}, ...unrecognized} = options || {};\n\n    // Preserve deprecated backwards compatibility for the 'origin' option\n    /* $FlowFixMe(>=0.68.0 site=react_native_fb) This comment suppresses an\n     * error found when Flow v0.68 was deployed. To see the error delete this\n     * comment and run Flow. */\n    if (unrecognized && typeof unrecognized.origin === 'string') {\n      console.warn(\n        'Specifying `origin` as a WebSocket connection option is deprecated. Include it under `headers` instead.',\n      );\n      /* $FlowFixMe(>=0.54.0 site=react_native_fb,react_native_oss) This\n       * comment suppresses an error found when Flow v0.54 was deployed. To see\n       * the error delete this comment and run Flow. */\n      headers.origin = unrecognized.origin;\n      /* $FlowFixMe(>=0.54.0 site=react_native_fb,react_native_oss) This\n       * comment suppresses an error found when Flow v0.54 was deployed. To see\n       * the error delete this comment and run Flow. */\n      delete unrecognized.origin;\n    }\n\n    // Warn about and discard anything else\n    if (Object.keys(unrecognized).length > 0) {\n      console.warn(\n        'Unrecognized WebSocket connection option(s) `' +\n          Object.keys(unrecognized).join('`, `') +\n          '`. ' +\n          'Did you mean to put these under `headers`?',\n      );\n    }\n\n    if (!Array.isArray(protocols)) {\n      protocols = null;\n    }\n\n    if (!WebSocket.isAvailable) {\n      throw new Error(\n        'Cannot initialize WebSocket module. ' +\n          'Native module WebSocketModule is missing.',\n      );\n    }\n\n    this._eventEmitter = new NativeEventEmitter(WebSocketModule);\n    this._socketId = nextWebSocketId++;\n    this._registerEvents();\n    WebSocketModule.connect(\n      url,\n      protocols,\n      {headers},\n      this._socketId,\n    );\n  }\n\n  get binaryType(): ?BinaryType {\n    return this._binaryType;\n  }\n\n  set binaryType(binaryType: BinaryType): void {\n    if (binaryType !== 'blob' && binaryType !== 'arraybuffer') {\n      throw new Error(\"binaryType must be either 'blob' or 'arraybuffer'\");\n    }\n    if (this._binaryType === 'blob' || binaryType === 'blob') {\n      invariant(\n        BlobManager.isAvailable,\n        'Native module BlobModule is required for blob support',\n      );\n      if (binaryType === 'blob') {\n        BlobManager.addWebSocketHandler(this._socketId);\n      } else {\n        BlobManager.removeWebSocketHandler(this._socketId);\n      }\n    }\n    this._binaryType = binaryType;\n  }\n\n  get binaryType(): ?BinaryType {\n    return this._binaryType;\n  }\n\n  close(code?: number, reason?: string): void {\n    if (this.readyState === this.CLOSING || this.readyState === this.CLOSED) {\n      return;\n    }\n\n    this.readyState = this.CLOSING;\n    this._close(code, reason);\n  }\n\n  send(data: string | ArrayBuffer | ArrayBufferView | Blob): void {\n    if (this.readyState === this.CONNECTING) {\n      throw new Error('INVALID_STATE_ERR');\n    }\n\n    if (data instanceof Blob) {\n      invariant(\n        BlobManager.isAvailable,\n        'Native module BlobModule is required for blob support',\n      );\n      BlobManager.sendOverSocket(data, this._socketId);\n      return;\n    }\n\n    if (typeof data === 'string') {\n      WebSocketModule.send(data, this._socketId);\n      return;\n    }\n\n    if (data instanceof ArrayBuffer || ArrayBuffer.isView(data)) {\n      WebSocketModule.sendBinary(binaryToBase64(data), this._socketId);\n      return;\n    }\n\n    throw new Error('Unsupported data type');\n  }\n\n  ping(): void {\n    if (this.readyState === this.CONNECTING) {\n      throw new Error('INVALID_STATE_ERR');\n    }\n\n    WebSocketModule.ping(this._socketId);\n  }\n\n  _close(code?: number, reason?: string): void {\n    if (Platform.OS === 'android') {\n      // See https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent\n      const statusCode = typeof code === 'number' ? code : CLOSE_NORMAL;\n      const closeReason = typeof reason === 'string' ? reason : '';\n      WebSocketModule.close(statusCode, closeReason, this._socketId);\n    } else {\n      WebSocketModule.close(this._socketId);\n    }\n\n    if (BlobManager.isAvailable && this._binaryType === 'blob') {\n      BlobManager.removeWebSocketHandler(this._socketId);\n    }\n  }\n\n  _unregisterEvents(): void {\n    this._subscriptions.forEach(e => e.remove());\n    this._subscriptions = [];\n  }\n\n  _registerEvents(): void {\n    this._subscriptions = [\n      this._eventEmitter.addListener('websocketMessage', ev => {\n        if (ev.id !== this._socketId) {\n          return;\n        }\n        let data = ev.data;\n        switch (ev.type) {\n          case 'binary':\n            data = base64.toByteArray(ev.data).buffer;\n            break;\n          case 'blob':\n            data = BlobManager.createFromOptions(ev.data);\n            break;\n        }\n        this.dispatchEvent(new WebSocketEvent('message', {data}));\n      }),\n      this._eventEmitter.addListener('websocketOpen', ev => {\n        if (ev.id !== this._socketId) {\n          return;\n        }\n        this.readyState = this.OPEN;\n        this.dispatchEvent(new WebSocketEvent('open'));\n      }),\n      this._eventEmitter.addListener('websocketClosed', ev => {\n        if (ev.id !== this._socketId) {\n          return;\n        }\n        this.readyState = this.CLOSED;\n        this.dispatchEvent(\n          new WebSocketEvent('close', {\n            code: ev.code,\n            reason: ev.reason,\n          }),\n        );\n        this._unregisterEvents();\n        this.close();\n      }),\n      this._eventEmitter.addListener('websocketFailed', ev => {\n        if (ev.id !== this._socketId) {\n          return;\n        }\n        this.readyState = this.CLOSED;\n        this.dispatchEvent(\n          new WebSocketEvent('error', {\n            message: ev.message,\n          }),\n        );\n        this.dispatchEvent(\n          new WebSocketEvent('close', {\n            message: ev.message,\n          }),\n        );\n        this._unregisterEvents();\n        this.close();\n      }),\n    ];\n  }\n}\n\nmodule.exports = WebSocket;\n"],"names":["Blob","require","d","EventTarget","NativeEventEmitter","BlobManager","NativeModules","WebSocketEvent","base64","binaryToBase64","invariant","WebSocketModule","CONNECTING","OPEN","CLOSING","CLOSED","nextWebSocketId","WebSocket","url","protocols","options","_this","_classCallCheck","this","_possibleConstructorReturn","_getPrototypeOf","call","readyState","_ref","_ref$headers","headers","undefined","unrecognized","_objectWithoutProperties","origin","console","warn","Object","keys","length","join","Array","isArray","isAvailable","Error","_eventEmitter","_socketId","_registerEvents","connect","code","reason","_close","data","sendOverSocket","ArrayBuffer","isView","sendBinary","send","ping","statusCode","closeReason","close","_binaryType","removeWebSocketHandler","_subscriptions","forEach","e","remove","_this2","addListener","ev","id","type","toByteArray","buffer","createFromOptions","dispatchEvent","_unregisterEvents","message","binaryType","addWebSocketHandler","apply","module","exports"],"mappings":"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","file":"136.js"}